<h2>Afanasy Render Host</h2>

<p>Render is a client application.
It runs on a remote host and communicates with server.
Server sends tasks to render to run.</p>

<p>There are several ways to launch render:</p>
<ul>
<li>Keeper AFANASY menu - on MS Windows only.
</li>
<li>MS Windows script<br/>
	<code>start\AFANASY\render.cmd</code>
</li>
<li>UNIX script<br/>
	<code>start/AFANASY/_afrender.sh</code>
</li>
<li>Linux daemon<br/>
	<code>/etc/init.d/afrender start</code><br/>
	If CGRU Linux packages installed.
</li>
<li>Setup CGRU environment and launch a command:<br/>
<pre>
$ cd cgru
$ source ./setup.sh
$ afrender
</pre>
</li>
</ul>

<h3>Render Attributes:</h3>
<ul>
<li><b class="anchor" id="Name">Name</b> - Each render has an unique name.
If new render comes to server with the name which already exists, server will not register it.
Users and jobs hosts masks (huntgroup) are based on render names.
and <a href="#regexp.html">Regular Expressions</a> (they are Perl-like).
<br/>
To launch another render on the same host use <kbd>AF_HOSTNAME</kbd> environment variable to override render name.
<br/><br/></li>
<li><b class="anchor" id="Address">Address</b> - IP address and port that render listening, if online.
<li><b class="anchor" id="NetworkInterfaces">Network Interfaces</b> - Network interfaces information (name, mac and ips).
<br/><br/></li>
<li><b class="anchor" id="TimeLaunch">Launch Time</b> - Time the application was launched.</li>
<li><b class="anchor" id="TimeRegister">Registration Time</b> - Time the render was registered on server.</li>
<li><b class="anchor" id="TimeUpdate">Last Update Time</b> - Last time the render has update its resources usage.
<li><b class="anchor" id="WOLOprerationTime">WOL Operation Time</b> - Time the last any WOL operation was performed.
<br/><br/></li>
<li><b class="anchor" id="Tasks">Tasks</b> - Running tasks number and some its attributes (user, job, etc.).</li>
<li><b class="anchor" id="CapacityUsed">Capacity Used</b> - Capacity used by running tasks.</li>
</ul>

<h3>Render Editable Parameters:</h3>
<ul>
<li><b class="anchor" id="UserName">Render User</b> - Who launched a render. Can be changed only by administrators. Note that process do not change uid. This value for afanasy only.</li>
<li><b class="anchor" id="Priority">Priority</b> - Render with greater priority get task first.</li>
<li><b class="anchor" id="Capacity">Capacity</b> - You can override host farm setup (see below) capacity.</li>
<li><b class="anchor" id="MaxTasks">Max Tasks</b> - You can override host farm setup (see below) maximum running tasks.</li>
<li><b class="anchor" id="DisabledServices">Disabled Services</b> - You can disable host farm setup (see below) service.</li>
<li><b class="anchor" id="State">Render State:</b>
   <ul>
   <li><b><i> Online       </i></b> - Render is online.</li>
   <li><b><i> nimby        </i></b> - Render is taken by his user. Only render user can render on it.</li>
   <li><b><i> NIMBY        </i></b> - Render is taken by his user and he don't want to render on it.</li>
   <li><b><i> Busy         </i></b> - Render executing one or more tasks.</li>
   <li><b><i> Dirty        </i></b> - Render capacity changed or some service disabled.</li>
   <li><b><i> WOLFalling   </i></b> - Render is falling a sleep. It was asked to sleep, but still online.</li>
   <li><b><i> SWOLSleeping </i></b> - Render is sleeping.</li>
   <li><b><i> SWOLWaking   </i></b> - Render is waking up. It was asked to wake up but still is not online.</li>
   </ul>
</li>
<li><b class="anchor" id="Annotation">Annotation</b> - Annotate render GUI item.</li>
</ul>

<h3>Render Host Attributes:</h3>
<ul>
<li><b class="anchor" id="Capacity">Capacity</b> - Total capacity value (each running task takes some capacity).</li>
<li><b class="anchor" id="MaxTasks">Max Tasks</b> - Maximum number of tasks can be running the same time.</li>
<li><b class="anchor" id="CpuNum">Number of CPUs</b> - Processors number.</li>
<li><b class="anchor" id="MHz">CPUs MHz</b> - Fist Processor frequency.</li>
<li><b class="anchor" id="MemoryMb">Memory Megabytes</b> - Total memory in megabytes.</li>
<li><b class="anchor" id="SwapMb">Swap Megabytes</b> - Total swap space in megabytes.</li>
<li><b class="anchor" id="HddGb">HDD Gigabytes</b> - Total disk space in gigabytes.
<br/><br/></li>
<li><b class="anchor" id="OS">OS</b> - OS name described in farm setup.</li>
<li><b class="anchor" id="Power">Power</b> - Custom number described in farm setup.</li>
<li><b class="anchor" id="Properties">Properties</b> - Custom string described in farm setup.
<br/><br/></li>
<li><b class="anchor" id="ServicesNames">Services Names</b> - List of type names of available services.</li>
</ul>

<h3>Render Host Resources Usage:</h3>
<ul>
<li><b class="anchor" id="CpuLoadavg">CPU Loadavg[3]</b> - Load average.</li>
<li><b class="anchor" id="CpuUser">CPU User</b> - User usage percentage.</li>
<li><b class="anchor" id="CpuNice">CPU Nice</b> - User 'nice' usage percentage (low priority processes).</li>
<li><b class="anchor" id="CpuSystem">CPU System</b> - System usage percentage.</li>
<li><b class="anchor" id="CpuIdle">CPU Idle</b> - Idle percentage (CPU free).</li>
<li><b class="anchor" id="CpuIOWait">CPU IO Wait</b> - Waiting for I/O complete percentage.</li>
<li><b class="anchor" id="CpuIRQ">CPU IRQ</b> - Interrupts servicing percentage.</li>
<li><b class="anchor" id="CpuIRQ">CPU Soft-IRQ</b> - Soft interrupts servicing percentage.
<br/><br/></li>
<li><b class="anchor" id="MemoryFreeMb">Memory Free Mb</b> - Free memory in megabytes.</li>
<li><b class="anchor" id="MemoryCachedMb">Memory Cached Mb</b> - Cached memory in megabytes.</li>
<li><b class="anchor" id="MemoryCachedMb">Memory Buffers Mb</b> - Buffered memory in megabytes.</li>
<li><b class="anchor" id="SwapUsedMb">Swap Used Mb</b> - Used swap in megabytes.</li>
<li><b class="anchor" id="HDDFreeGb">HDD Free Gb</b> - Available free disk space in gigabytes (in root - '/').</li>
<li><b class="anchor" id="NetRecvKbSec">Net Received Kb/Sec</b> - Network receiving traffic in kilobytes per second.</li>
<li><b class="anchor" id="NetSendKbSec">Net Send Kb/Sec</b> - Network sending traffic in kilobytes per second.</li>
<li><b class="anchor" id="DiskRdKbSec">Disk Read Kb/Sec</b> - Disk reading in kilobytes per second.</li>
<li><b class="anchor" id="DiskWrKbSec">Disk Write Kb/Sec</b> - Disk writing in kilobytes per second.</li>
<li><b class="anchor" id="DiskBusy">Disk Busy</b> - Percentage of system ticks spend for the disk IO.</li>
</ul>

<p>To register a render already in [nimby|NIMBY] state use command:</p>
<p><code>$ afrender [nimby|NIMBY]</code></p>


<h2 id="config" class="anchor">Configuration</h2>

<ul>
<li><p>
<code class="anchor" id="cmd_shell">cmd_shell</code> not defined by default.<br/>
Shell command used to launch any other command. It is important that it will be used by render to launch task process.
If not defined build-in values are used:<br/>
<i>UNIX</i>: "/bin/bash -c"<br/>
<i>MS Windows</i>: "cmd.exe /c"<br/>
</p></li>
<li><p>
<code>render_default_capacity</code> = 1000<br/>
Default render capacity value, if not set in farm config.
</p></li>
<li><p>
<code>render_default_maxtasks</code> = 5<br/>
Maximum allowed simultaneously running tasks on render, if not set in farm config.
</p></li>
<li><p>
<code>render_hddspace_path</code> = /<br/>
Path to measure free disk space ('/' - for MS Windows means the root of the system disk).
</p></li>
<li><p>
<code>render_networkif</code> = (?!lo$).*<br/>
Network interface(s) name pattern to measure network traffic on.
It will be a sum of traffic if several interfaces matching pattern are founded.
Specified above default pattern matches any name except <i>lo</i> (loopback interface name).
</p></li>
<li><p>
<code>render_iostat_device</code> = sda<br/>
Device to measure disk IO statistics (for MS Windows - statistics only for first disk available).
</p></li>
<li><p>
<code>render_resclasses</code> = example;iostat<br/>
Custom resources meter(s). Python class name(s), if several - list separated with ';' character.
</p></li>
<li><p>
<code>render_customiostat_devices</code> = sda<br/>
Device(s) for custom python resource meter "<i>iostat</i>".
To watch several devices use regular expression, for example "<i>sda[2-4]</i>".
If several devices matching pattern are founded,
it calculates the sum of traffic parameters and maximum of utilization parameters.
</p></li>
<li><p>
<code>render_nice</code> = 10<br/>
Renice task command process on render.
</p></li>
<li><p>
<code>render_update_sec</code> = 5 (seconds)<br/>
Render resources update interval.
</p></li>
<li><p>
<code>render_updatetaskperiod</code> = 1 (seconds)<br/>
Period to render to update task state or percentage (even if there is no parser).
</p></li>
<li><p>
<code>render_zombietime</code> = 60 (seconds)<br/>
Time to server to delete render if there is no update (resources usage) for this period.
</p></li>
<li><p>
<code>render_connectretries</code> = 3<br/>
Connection fails times to consider to render that there is no connection to server.
</p></li>
<li><p>
<code>render_waitforconnected</code> = 15000 (milliseconds)<br/>
Time to wait for connection establishing to consider that connection is available.
</p></li>
<li><p>
<code>render_waitforreadyread</code> = 15000 (milliseconds)<br/>
Time to wait for incoming data to consider that connection is not lost.
</p></li>
<li><p>
<code>render_waitforbyteswritten</code> = 15000 (milliseconds)<br/>
Time to wait for writing data to consider that connection is not lost.
</p></li>
<li><p>
<code>render_logs_linesmax</code> = 100<br/>
Server truncates log above this limit.
</p></li>
<li><p>
<code>render_logs_rotate</code> = 10<br/>
Server store logs of renders with the same name by renaming old. It adds a number to the end of old file name (logs rotating).
</p></li>
<!--
<li><p>
<code>render_exec</code> = afrender<br/>
Command for render to execute another render or to restart.
</p></li>
-->
<li><p>
<code>render_cmd_reboot</code> = reboot<br/>
Command for render to reboot a machine. For MS Windows you can use "shutdown /r".
</p></li>
<li><p>
<code>render_cmd_shutdown</code> = shutdown -P 1 afrequest<br/>
Command for render to shutdown a machine. For MS Windows you can use "shutdown /s".
</p></li>
</ul>

<h2 class="anchor" id="customresources">Custom Resources</h2>

<p>
You can write custom resources meter(s) on Python.
Render instances a class and runs <kbd>update</kbd> method periodically (each time the Render updates).
You can inherit base <kbd>resbase</kbd> class and set its properties.
</p>

<p>
There are some examples of custom meters in Afanasy.
</p>
<ul>
<li><b>example</b> - Just an example. It increments a value from 0 to 100, changes label text, plotter and label size, graph and back color.</li>
<li><b>iostat</b> - Shows parsed output of Linux '<i>iostat</i>' command. Graph value is utilization percentage (or %busy).</li>
</ul>

<p>
This is how Watch shows two custom resources meters <kbd>example</kbd> and <kbd>iostat</kbd>.<br/>
<img src="images/afanasy/watch/render_rescustom.png" alt="render_rescustom.png"><br/>
It places custom plotters in a second row, under standard build-in resources meters.<br/>
</p>

<p>
Python classes stored in <br/>
<code>cgru/afanasy/python/resources</code><br/>
and based from <br/>
<code>cgru/afanasy/python/resources/resbase.py</code><br/>
</p>

<h3>Properties:</h3>
<ul>
<li><b>self.value</b> (<kbd>int</kbd>) - The resource value to watch.
<li><b>self.valuemax</b> (<kbd>int</kbd>) - Maximum resource value for graph scale.
<li><b>self.height</b> (<kbd>int</kbd>) - Preferred plotter widget height for GUI.
<li><b>self.width</b> (<kbd>int</kbd>) - Preferred plotter widget width for GUI.
<li><b>self.graphr self.graphrg self.graphb</b> (<kbd>int</kbd>) - Graph color.
<li><b>self.label</b> (<kbd>str</kbd>) - Label text.
<li><b>self.labelsize</b> (<kbd>int</kbd>) - Label text font size.
<li><b>self.labelr self.labelg self.labelb</b> (<kbd>int</kbd>) - Label text font color.
<li><b>self.bgcolorr self.bgcolorg self.bgcolorb</b> (<kbd>int</kbd>) - Plotter background color.
<li><b>self.tooltip</b> (<kbd>str</kbd>) - Widget tooltip.
<li><b>self.valid</b> (<kbd>False|True</kbd>) - Resource meter validness.
Should be set to <kbd>True</kbd> in constructor, or update function will not be called.
Set <kbd>False</kbd> if resource meter initialization failed.
</li>
</ul>


<h2 id="windowsmustdie" class="anchor">Windows Must Die</h2>
<p>
Farm based on MS Windows OS can produce some 'bad' windows.
If process crashed, Windows OS can launch a window with apologizes,
and 'hung' the process until someone closes this window.
</p>
<p>
Afanasy Render client periodically finds windows listed in 
<kbd>afanasy/windowsmustdie*.txt</kbd>
file(s), and closes them (sends WM_CLOSE signal).
</p>

<h3>windowsmustdie.txt example:</h3>
<pre>
   Visual Studio Just-In-Time Debugger   
   mantra.exe
   mantra.exe - Application Error
   Nuke6.2.exe - Application Error
</pre>

